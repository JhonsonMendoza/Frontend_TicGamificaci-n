'use client';

import React, { useState } from 'react';
import { Mission } from '@/apis/missions.api';

interface VulnerabilityMissionCardProps {
  mission: Mission;
  onComplete?: (id: number) => Promise<Mission | null | void>;
  onSkip?: (id: number) => Promise<Mission | null | void>;
  isLoading?: boolean;
}

const VulnerabilityMissionCard: React.FC<VulnerabilityMissionCardProps> = ({
  mission,
  onComplete,
  onSkip,
  isLoading = false,
}) => {
  const [isCompleting, setIsCompleting] = useState(false);
  const [isSkipping, setIsSkipping] = useState(false);
  const [expanded, setExpanded] = useState(false);

  const handleComplete = async () => {
    if (!onComplete) return;
    setIsCompleting(true);
    try {
      await onComplete(mission.id);
    } finally {
      setIsCompleting(false);
    }
  };

  const handleSkip = async () => {
    if (!onSkip) return;
    setIsSkipping(true);
    try {
      await onSkip(mission.id);
    } finally {
      setIsSkipping(false);
    }
  };

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'high':
        return {
          bg: 'bg-red-50',
          border: 'border-red-300',
          badge: 'bg-red-100 text-red-800',
          icon: 'üî¥',
        };
      case 'medium':
        return {
          bg: 'bg-yellow-50',
          border: 'border-yellow-300',
          badge: 'bg-yellow-100 text-yellow-800',
          icon: 'üü°',
        };
      case 'low':
        return {
          bg: 'bg-green-50',
          border: 'border-green-300',
          badge: 'bg-green-100 text-green-800',
          icon: 'üü¢',
        };
      default:
        return {
          bg: 'bg-gray-50',
          border: 'border-gray-300',
          badge: 'bg-gray-100 text-gray-800',
          icon: '‚ö™',
        };
    }
  };

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'fixed':
        return '‚úÖ';
      case 'skipped':
        return '‚è≠Ô∏è';
      case 'pending':
        return '‚è≥';
      default:
        return '‚Ä¢';
    }
  };

  // Renderizar markdown manualmente para mejor control
  const renderMarkdown = (text: string) => {
    if (!text) return null;
    
    const lines = text.split('\n');
    return lines.map((line, idx) => {
      // T√≠tulos (bold)
      if (line.startsWith('**') && line.endsWith('**')) {
        return (
          <h3 key={idx} className="font-bold text-gray-900 dark:text-white mt-3 mb-2 text-sm">
            {line.replace(/\*\*/g, '')}
          </h3>
        );
      }
      // C√≥digo inline
      if (line.includes('```')) {
        return null; // Ser√° manejado en bloques
      }
      // Bullet points
      if (line.startsWith('-')) {
        return (
          <li key={idx} className="ml-4 text-gray-700 dark:text-gray-300">
            {line.substring(1).trim()}
          </li>
        );
      }
      // Enlaces
      if (line.includes('[') && line.includes('](')) {
        return (
          <p key={idx} className="text-gray-700 dark:text-gray-300 mb-2">
            {line}
          </p>
        );
      }
      // L√≠nea normal
      if (line.trim()) {
        return (
          <p key={idx} className="text-gray-700 dark:text-gray-300 mb-2 text-sm leading-relaxed">
            {line}
          </p>
        );
      }
      return null;
    });
  };

  const colors = getSeverityColor(mission.severity);
  const descriptionParts = mission.description?.split('---') || [];
  const mainContent = descriptionParts[0] || '';
  const technicalDetails = descriptionParts[1] || '';

  return (
    <div
      className={`rounded-lg border-2 ${colors.border} ${colors.bg} p-5 transition-all duration-300 hover:shadow-lg`}
    >
      {/* Header */}
      <div className="flex items-start justify-between mb-4">
        <div className="flex-1">
          <div className="flex items-start gap-2 mb-2">
            <span className="text-2xl flex-shrink-0">{colors.icon}</span>
            <div className="flex-1">
              <h3 className="font-bold text-base text-gray-900 dark:text-white leading-snug">
                {mission.title}
              </h3>
            </div>
          </div>
          <div className="flex gap-2 flex-wrap">
            <span className={`px-2 py-1 rounded text-xs font-semibold ${colors.badge}`}>
              {mission.severity.toUpperCase()}
            </span>
            <span className="px-2 py-1 rounded text-xs font-semibold bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400">
              {getStatusIcon(mission.status)} {mission.status.toUpperCase()}
            </span>
          </div>
        </div>
      </div>

      {/* Main Content - Educational Part */}
      <div className="mb-4 text-sm text-gray-700 dark:text-gray-300">
        {renderMarkdown(mainContent)}
      </div>

      {/* Code Examples Block */}
      {mainContent.includes('```') && (
        <div className="mb-4 bg-gray-900 text-gray-100 p-4 rounded text-xs font-mono overflow-x-auto">
          <pre className="whitespace-pre-wrap break-words">
            {mainContent.split('```').slice(1, -1).map((block, i) => (
              <code key={i}>{block}</code>
            ))}
          </pre>
        </div>
      )}

      {/* File Location */}
      {mission.filePath && (
        <div className="mb-4 p-3 bg-white/50 dark:bg-gray-800/50 rounded border border-gray-200 dark:border-gray-700">
          <div className="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">üìÅ Ubicaci√≥n del error:</div>
          <div className="text-xs font-mono text-gray-700 dark:text-gray-300 break-all">{mission.filePath}</div>
          {mission.lineStart && (
            <div className="text-xs text-gray-600 dark:text-gray-400 mt-1">
              üìç L√≠nea {mission.lineStart}{mission.lineEnd && mission.lineEnd !== mission.lineStart ? ` - ${mission.lineEnd}` : ''}
            </div>
          )}
          {(mission as any).codeSnippet && (
            <div className="mt-2 p-2 bg-gray-900 dark:bg-gray-950 rounded text-xs font-mono text-yellow-200 overflow-x-auto">
              <code>{(mission as any).codeSnippet}</code>
            </div>
          )}
        </div>
      )}

      {/* Technical Details - Expandable */}
      {technicalDetails && (
        <div className="mb-4">
          <button
            onClick={() => setExpanded(!expanded)}
            className="text-xs font-semibold text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 flex items-center gap-1"
          >
            {expanded ? '‚ñº' : '‚ñ∂'} Detalles t√©cnicos
          </button>
          {expanded && (
            <div className="mt-2 p-3 bg-gray-100 dark:bg-gray-900 rounded text-xs text-gray-600 dark:text-gray-400 border border-gray-300 dark:border-gray-700">
              <pre className="whitespace-pre-wrap break-words">{technicalDetails.trim()}</pre>
            </div>
          )}
        </div>
      )}

      {/* Timestamps */}
      <div className="mb-4 text-xs text-gray-500 dark:text-gray-400 space-y-1">
        <div>üìÖ Detectado: {new Date(mission.createdAt).toLocaleDateString('es-ES')}</div>
        {mission.fixedAt && (
          <div className="text-green-600 dark:text-green-400">‚úÖ Completado: {new Date(mission.fixedAt).toLocaleDateString('es-ES')}</div>
        )}
      </div>

      {/* Actions */}
      {mission.status === 'pending' && (
        <div className="flex gap-2">
          <button
            onClick={handleComplete}
            disabled={isCompleting || isLoading}
            className="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2 text-sm"
          >
            {isCompleting ? (
              <>
                <span className="animate-spin">‚è≥</span> Marcando...
              </>
            ) : (
              <>‚úÖ Marcar como Completado</>
            )}
          </button>
          <button
            onClick={handleSkip}
            disabled={isSkipping || isLoading}
            className="flex-1 px-4 py-2 bg-gray-500 hover:bg-gray-600 disabled:bg-gray-300 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2 text-sm"
          >
            {isSkipping ? (
              <>
                <span className="animate-spin">‚è≥</span> Omitiendo...
              </>
            ) : (
              <>‚è≠Ô∏è Omitir</>
            )}
          </button>
        </div>
      )}

      {mission.status === 'fixed' && (
        <div className="text-center py-2 bg-green-100 dark:bg-green-900/30 rounded font-semibold text-green-700 dark:text-green-400 text-sm">
          ‚úÖ Misi√≥n Completada
        </div>
      )}

      {mission.status === 'skipped' && (
        <div className="text-center py-2 bg-gray-100 dark:bg-gray-900/30 rounded font-semibold text-gray-700 dark:text-gray-400 text-sm">
          ‚è≠Ô∏è Omitida
        </div>
      )}
    </div>
  );
};

export default VulnerabilityMissionCard;
